[{"categories":["代码"],"content":"以webapi为例，webapi 是web后台接口。负责任务的增删改查、将任务分发到真实运行的节点、提供统计查询和相关告警信息查询。如下是打包以后可运行的安装包目录 [root@localhost webapi-0.1.1]$ tree -a . ├── bin #可执行文件bin目录 │ └── webapi ├── conf #配置目录 │ └── conf.yml ├── docker-entrypoint.sh #docker entrypoint ├── Dockerfile ├── .dockerignore #忽略文件声明 (忽略安装脚本，更新脚本，Dockerfile) ├── install.sh #非docker版本 安装脚本 ├── ssl #自带证书 │ ├── key.crt │ └── tls.crt └── update.sh #非docker版本 更新脚本 其中Dockerfile 内容如下： debian 版本 FROMdebian:buster-slimLABEL author=\"tjuliuyou@gmail.com\" \\ description=\"my web api app\"# 注意使用 .dockerignore 忽略其他文件ADD ./ / ENV CONFIG_FILE=/conf/conf.ymlENV LOG_LEVEL=INFO ENV VERBOSE=2 EXPOSE80ENTRYPOINT [\"/docker-entrypoint.sh\"]CMD [\"webapi\"] alpine 版本 FROMalpine:3.10LABEL author=\"tjuliuyou@gmail.com\" \\ description=\"my web api app\"# 注意使用 .dockerignore 忽略其他文件ADD ./ / ENV CONFIG_FILE=/conf/conf.ymlENV LOG_LEVEL=INFO ENV VERBOSE=2 EXPOSE80ENTRYPOINT [\"/docker-entrypoint.sh\"]CMD [\"webapi\"] 其中 docker-entrypoint.sh文件如下： #!/usr/bin/env bash # # Created by tjuliuyou on 21/02/25. # set -e # if command starts with an option, prepend webapi if [ \"${1:0:1}\" = '-' ]; then set -- webapi \"$@\" fi # cd workspace # if command webapi only, add use default args if [ \"$1\" = 'webapi' ] \u0026\u0026 [ \"$#\" -eq 1 ]; then exec webapi -conf ${CONFIG_FILE} -log_level ${LOG_LEVEL} -verbose ${VERBOSE} -logtostderr true fi exec \"$@\" k8s 部署实例(关键部分) #...template:metadata:labels:app:webapispec:volumes:- name:secret-volumesecret:secretName:app-tls- name:conf-volumeconfigMap:name:webapi-configaffinity:nodeAffinity:requiredDuringSchedulingIgnoredDuringExecution:nodeSelectorTerms:- matchExpressions:- key:kubernetes.io/hostnameoperator:Invalues:- node1.skynetcloud.com containers:- name:webapiimage:webapi:latestports:- containerPort:80volumeMounts:- name:secret-volumemountPath:/ssl- name:conf-volumemountPath:/conf/conf.ymlsubPath:conf.ymlenv:- name:VERBOSEvalue:2 alpine 版本需要添加额外DNS选项 template:metadata:labels:app:webapispec:volumes:- name:secret-volumesecret:secretName:app-tlscontainers:- name:webapiimage:webapi:latestports:- containerPort:80volumeMounts:- name:conf-volumemountPath:/conf/conf.ymlsubPath:conf.ymlenv:- name:VERBOSEvalue:2dnsConfig:options:- name:ndotsvalue:\"2\" 解释：域名中不大于两个点将会从搜索域中搜索该域名解析，这种写法对于主域名可能还是会存在问题 举例而言：例如（magic.ac.cn) magic.ac.cn -\u003e 异常解析 www.magic.ac.cn -\u003e 正常解析 参考 kubernetes容器中域名解析优化 ","date":"2021-02-25","objectID":"/2021/02/docker_demo/:0:0","tags":["k8s","docker"],"title":"编译docker实例","uri":"/2021/02/docker_demo/"},{"categories":["代码"],"content":"FAQ 1. ENTRYPOINT 与 CMD 使用？ ENTRYPOINT不会被直接覆盖：使用场景为入口点；CMD 可以被覆盖：使用场景一般填写入口参数。具体而已参考上一节webapi实例 当不输入任何参数时，使用默认参数相当于运行 bash /docker-entrypoint.sh webapi [root@localhost webapi]$ docker run -it webapi:0.1.1 I1028-15:48:25.878 main.go:43] 当前WebAPI版本: 0.1.1 I1028-15:48:25.878 main.go:44] Git Commit Hash : 115827ab9e8696e141d58b47f7170f21f932f08d I1028-15:48:25.878 main.go:45] UTC Build Time : 2021-02-25_07:15:12上午 ... 可以\u0008通过-e 传递环境变量 如：docker run -it -e CONFIG_FILE=/app/config.yaml webapi:0.9.2-643 当输入--help参数时，使用附带参数，相当于运行 bash /docker-entrypoint.sh webapi --help [root@localhost webapi]$ docker run -it webapi:0.1.1 --help Usage of webapi: -conf string The configure file (default \"conf.yml\") -log_dir string If non-empty, write log files in this directory -log_level value logs at or above this threshold go to stderr -logtostderr log to standard error instead of files -pprof string [localhost:6060]start debug page. -verbose value log level for V logs -version show build version. failed to resize tty, using default size ... 当输入bash参数时，使用附带参数，相当于运行 bash /docker-entrypoint.sh bash [root@localhost webapi]$ docker run -it webapi:0.1.1 bash root@09b00aa0f1bc:/# ls bin boot conf dev docker-entrypoint.sh etc home lib lib64 media mnt opt proc root run sbin srv ssl sys tmp usr var root@09b00aa0f1bc:/# exit 2. 为什么使用 debian:buster-slim 替换 alpine 优点: Alpine Linux 使用了 musl，可能和其他 Linux 发行版使用的 glibc 实现会有所不同。在容器化中最可能遇到的是 DNS 问题，即 musl 实现的 DNS 服务不会使用 resolv.conf 文件中的 search 和 domain 两个配置，这对于一些通过 DNS 来进行服务发现的框架可能会遇到问题 debian:buster-slim编译脚本如下：添加了默认UTC+8时区配置；添加了智为默认RootCA证书 FROMdebian:buster-slimLABEL author=\"tjuliuyou@gmail.com\" \\ version=\"1.0.0\" \\ description=\"my k8s base container\"COPY sources.list /etc/apt/sources.listRUN apt-get update \u0026\u0026 \\ apt-get install -y ca-certificates \u0026\u0026 \\ rm -rf /var/lib/apt/lists/* \u0026\u0026 \\ update-ca-certificates \u0026\u0026 \\ cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtimeCMD [\"/bin/bash\"] 缺点： 体积变大 5M -\u003e50M ","date":"2021-02-25","objectID":"/2021/02/docker_demo/:0:1","tags":["k8s","docker"],"title":"编译docker实例","uri":"/2021/02/docker_demo/"},{"categories":["活着","碎碎念"],"content":"01 假期就这样完结，没有回乡。2020年过得不尽人意，自己割了烂尾，老婆孩子每人都肺炎住院超过一周。本来打算去一趟衡阳拜佛「虽然自己不信这些，但是给家人未来会变好的仪式感还是很重要的」，但是因为疫情「就地过年」居然限制要在长沙地区，而且据说风景区也关门了。最后，也只是在附近公园溜达了一整个假期。对于两个孩子奴来说，干瘪的生活被两个女儿挤得满满当当的，某种意义上说也是中幸福。总有说没有年味了。我觉得更多还是自己过了那个年纪。每个年纪应该做这个年纪该做的事情。至少家了的小孩是很期待过年的。我们总要给她们创造属于他们的年味记忆。 ","date":"2021-02-18","objectID":"/2021/02/first_workday_of_2021/:0:1","tags":["随笔"],"title":"开工","uri":"/2021/02/first_workday_of_2021/"},{"categories":["活着","碎碎念"],"content":"02 今天是农历新年第一天上班，实习的小妹子发微信说要去考公务员。我很早就看到了，但是一直没有答复。因为不知道该怎么去答复。似乎每次新年一过人员总是不那么稳定。年前信誓旦旦的说要一起去看星辰大海。走着走着就可能嫌弃小船太慢了。小公司真的是很难。虽说原因是可能是自身竞争力不够。对我来说的结果就是心情比较难受，接下来的工作也会比较难受。都说要团队作战，没有稳定的核心团队又能做什么呢？ ","date":"2021-02-18","objectID":"/2021/02/first_workday_of_2021/:0:2","tags":["随笔"],"title":"开工","uri":"/2021/02/first_workday_of_2021/"},{"categories":["活着","碎碎念"],"content":"03 生活不易，有时候，都不知道要怎样面对这层层荆棘。不过，感谢上苍把两个女儿带到我的身边，用她们的童真卸下一整天的疲惫。 ","date":"2021-02-18","objectID":"/2021/02/first_workday_of_2021/:0:3","tags":["随笔"],"title":"开工","uri":"/2021/02/first_workday_of_2021/"},{"categories":["活着"],"content":"01 最近一家公司一家入职超过四年了，突然觉得很没意思。和工作相关，却也无关。相关的是已经尽力做到最好，却也是忙碌到平庸到重复日子。无关又是因为这种状态不仅仅是因为工作所带来的。更多的是生活带来的无力感。不管作出怎样的努力，总是跳不出自己的纬度与认知，自然也就没法跟进一步的突破自身的周遭走到另外一个台阶（包括自身能力抑或是金钱）。 ","date":"2021-01-29","objectID":"/2021/01/key_of_life/:0:1","tags":["随笔"],"title":"Key Of Life","uri":"/2021/01/key_of_life/"},{"categories":["活着"],"content":"02 前些日子看了一个电影堺雅人主演的《盗钥匙的方法》。其实这个翻译名有点怪，英文名《key of life》更加贴合电影表达的内容。电影讲述的是两个不同性格（生活习惯/态度）的人互换身份以后荒诞的经历的故事。对消极的人来说摇摇欲坠甚至自杀的生活残局，搁到积极的人手上，仍然可以梳理得平顺，修缮得完整，重新走向正轨。里面有一段台词让人印象深刻： 你房间里那本斯特拉斯伯格的书 只看了前面的8页 其它书也是一样 好不容易稍微有点学习的干劲了 可是书一买回来就满足了 你小子就是那种最渣的人 ","date":"2021-01-29","objectID":"/2021/01/key_of_life/:0:2","tags":["随笔"],"title":"Key Of Life","uri":"/2021/01/key_of_life/"},{"categories":["活着"],"content":"03 所以，我想表达什么呢？Key of life 是什么？个人认为还是自律和好的习惯。习惯决定了自身发展的方向。如果说好的习惯可以让自己向上突破。那这种“复利”效应会随着时间累积成优势最终突破自身的纬度，达到下一个等级。相反差的习惯是向下“复利”的。即使起点很高，或者偶尔的好运（机遇）来啦。最终总是会走向本来的自己。这和一段名言其实也是契合： 你永远赚不到超出你认知范围外的钱 除非你靠运气 但靠运气赚到的钱，最后往往又会靠实力亏掉 这是一种必然 你所赚的每一分钱 都是你对这个世界认知的变现 你所亏的每一分钱 都是因为对这个世界认知有缺陷 这个世界最大的公平在于 当一个人的财富大于自己认知的时候 这个社会有100种方法收割你 直到你的认知和财富相匹配为止 自己的停步不前和自己的习惯是相关的。控制不了自己刷一些垃圾知乎文章，看一些无聊的笑话；每天工作没有花10分钟总结和反思；做决定凭直觉而非理性分析判断；没有定期的运动与健身等等这些都是让我止步不前的习惯。So： 这就是2021年应该作出的改变吧 ","date":"2021-01-29","objectID":"/2021/01/key_of_life/:0:3","tags":["随笔"],"title":"Key Of Life","uri":"/2021/01/key_of_life/"},{"categories":null,"content":"时隔5年再次捡起自己的网站，但还是希望自己能挤出时间锻炼一下书写博客，文档的能力。 ","date":"2021-01-25","objectID":"/2021/01/first/:0:0","tags":null,"title":"Bring My Own Candy","uri":"/2021/01/first/"},{"categories":null,"content":"个人简介 小小程序员一枚。11年毕业于天津大学。(TODO) ","date":"2021-01-25","objectID":"/about/:0:1","tags":null,"title":"关于","uri":"/about/"},{"categories":null,"content":"关于本站 关于晨熙 晨/熙是我两个女儿的名字，紧巴的日子里，她们是我成长的动力源泉。希望她们能永远健康快乐。 版权说明 本站采用更开放的「署名 4.0 国际（CC BY 4.0）」创作共享协议。通俗地讲，只要在使用时署名，那么使用者可以对本站所有原创内容进行转载、节选、混编、二次创作，允许商业性使用。 ","date":"2021-01-25","objectID":"/about/:0:2","tags":null,"title":"关于","uri":"/about/"}]